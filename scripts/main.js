function initMap(){function e(e){jQuery.ajax({url:"https://api.map.baidu.com/place/v2/search",type:"GET",dataType:"jsonp",data:{q:"旅游景点",scope:"2",filter:"sort_name:好评|sort_rule:0",region:e,output:"json",ak:"oXmLrK2EjxWxZm1qab51f1fmRLm4I4kF",page_size:"20",page_num:"0"}}).done(function(e,a,o){locations=e.results,t(locations)}).fail(function(e,a,t){console.log("HTTP Request Failed"),alert("Baidu search results could not load properly. Please try again in a few minutes.")})}function a(e){e.forEach(function(e){e.setMap(null)})}function t(e){a(markers),markers=[],tags=[];var t=[],r=$("#places");r.empty();var n=new google.maps.LatLngBounds;e.forEach(function(e,a){var o=e.name,i=e.location,s="";e.detail_info&&(s=e.detail_info.tag,t=e.detail_info.tag.split(";"),t.forEach(function(e){tags.push(e)}));var c="ABCDEFGHIJKLMNOPQRSTUVWXYZ",u="N/A";e.detail_info&&(u=e.detail_info.overall_rating);var m=new google.maps.Marker({map:map,position:i,title:o,cursor:s,animation:google.maps.Animation.DROP,label:c[a]}),y=$('<li class="list">'+o+" <br> Rating: "+u+" | "+s+"</li> ");y.click(function(a){window.setTimeout(function(){map.panTo(m.getPosition())},100),infowindowOpen&&activeMarker===m?d(m,p):(l(m,p,n,e),d(m,p))}),r.append(y),m.addListener("click",function(){window.setTimeout(function(){map.panTo(m.getPosition())},100),infowindowOpen&&activeMarker===m?d(m,p):(l(m,p,n,e),d(m,p))}),markers.push(m),n.extend(markers[a].position)});var i=_.uniq(tags);o(i),map.fitBounds(n)}function o(e){var a=$("#js-filter");a.empty(),a.append("<label>Filter by Tag:</label>");var t=$('<select id="selectTag"class="form-control"></select>');a.append(t),t.change(function(e){r(e.target.value),p.close(),activeMarker=null}),e.forEach(function(e){n(e);var a=$('<option id="'+e+'" value="'+e+'">'+e+"</option>");t.append(a)})}function r(e){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZ",t=0;markers.forEach(function(o,r){markerTag=o.cursor,markerTag.indexOf(e)>=0?(o.setMap(map),o.setLabel(a[t]),t++):o.setMap(null)}),$(".list").hide();var o=$(".list:contains("+e+")");o.show()}function n(e){var a="No Word Found";jQuery.ajax({url:"https://www.googleapis.com/language/translate/v2",type:"GET",data:{key:"AIzaSyAzaEzWmHAh91ZM2kLFg0wE4oGsXujnDpc",q:e,source:"zh-CN",target:"en"}}).done(function(t,o,r){a=t.data.translations[0].translatedText,i(e,a)}).fail(function(e,a,t){console.log("HTTP Request Failed")})}function i(e,a){var t=$("#"+e);t.append(" | "+a)}function l(e,a,t,o){var r=new google.maps.places.PlacesService(map);r.textSearch({query:e.title,bounds:t},function(t,r){if(r===google.maps.places.PlacesServiceStatus.OK){var n=new google.maps.places.PlacesService(map);n.getDetails({placeId:t[0].place_id},function(t,r){if(r===google.maps.places.PlacesServiceStatus.OK){c(t),a.marker=e;var n="<div>";t.name&&(n+="<strong>"+t.name+"</strong>"),t.formatted_address&&(n+="<br>"+t.formatted_address),t.formatted_phone_number&&(n+="<br>"+t.formatted_phone_number),o.detail_info&&(o.detail_info.overall_rating&&(n+="<br> Baidu Rating: "+o.detail_info.overall_rating),o.detail_info.price&&(n+="<br> Price: "+o.detail_info.price+" 元")),t.opening_hours&&(n+="<br><br><strong>Hours:</strong><br>"+t.opening_hours.weekday_text[0]+"<br>"+t.opening_hours.weekday_text[1]+"<br>"+t.opening_hours.weekday_text[2]+"<br>"+t.opening_hours.weekday_text[3]+"<br>"+t.opening_hours.weekday_text[4]+"<br>"+t.opening_hours.weekday_text[5]+"<br>"+t.opening_hours.weekday_text[6]),t.photos&&(n+='<br><br><img src="'+t.photos[0].getUrl({maxHeight:100,maxWidth:200})+'">'),n+="</div>",a.setContent(n),a.open(map,e),a.addListener("closeclick",function(){a.marker=null,activeMarker.setLabel(activeMarker.saveLabel),activeMarker=null})}else s()})}else s()})}function s(){$("#noData").fadeIn("slow").animate({opacity:1},2500).fadeOut("slow")}function c(e){function a(a,t){var o=$("#panorama");if(t==google.maps.StreetViewStatus.OK){o.show();var r=a.location.latLng,n=google.maps.geometry.spherical.computeHeading(r,e.geometry.location),i={position:r,pov:{heading:n,pitch:10}};new google.maps.StreetViewPanorama(document.getElementById("panorama"),i)}else o.css("display","none"),$("#noPano").fadeIn("slow").animate({opacity:1},2500).fadeOut("slow")}var t=new google.maps.StreetViewService,o=50;t.getPanoramaByLocation(e.geometry.location,o,a)}function d(e,a){activeMarker?activeMarker!==e?(activeMarker.setAnimation(null),activeMarker.setLabel(activeMarker.saveLabel),e.saveLabel=e.getLabel(),e.setLabel(null),activeMarker=e,e.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){e.setAnimation(null)},1400)):activeMarker===e&&(activeMarker.setAnimation(null),activeMarker.setLabel(activeMarker.saveLabel),p.close(),infowindowOpen=!1,activeMarker=null):(e.saveLabel=e.getLabel(),e.setLabel(null),activeMarker=e,e.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){e.setAnimation(null)},1400),infowindowOpen=!0)}map=new google.maps.Map(document.getElementById("map"),{center:{lat:22.396428,lng:114.109497},zoom:12,styles:styles});var p=new google.maps.InfoWindow;e("香港"),$("#js-city").change(function(a){e(a.target.value)})}function mapError(){$("#noMap").fadeIn("slow").animate({opacity:1},4500)}function getHarvardData(){var e="",a=document.getElementById("js-city").value;switch(a){case"香港":e="2028558";break;case"北京":e="2035839";break;case"上海":e="2040128";break;case"天津":e="2035836"}jQuery.ajax({url:"https://api.harvardartmuseums.org/object",type:"GET",data:{place:e,apikey:"0c781bd0-8a9f-11e6-bcde-977dd71a47a9",size:"50"}}).done(function(e,a,t){console.log("HTTP Request Succeeded: "+t.status),0===e.records.length&&$("#noData").fadeIn("slow").animate({opacity:1},2500).fadeOut("slow");var o=$.map(e.records,function(e){var a=e.primaryimageurl+"?width=600";return new ArtObject(e.title,e.department,e.primaryimageurl,a,e.dated,e.period,e.culture,e.dimensions,e.creditline)});appViewModel.artObjects(o),addLightbox()}).fail(function(e,a,t){console.log("HTTP Request Failed"),getStoredHarvardData()})}function getStoredHarvardData(){var e="",a=document.getElementById("js-city").value;switch(a){case"香港":e="2028558";break;case"北京":e="2035839";break;case"上海":e="2040128";break;case"天津":e="2035836"}$.ajax({url:"./json/"+e+".json",type:"GET",dataType:"json"}).done(function(e,a,t){0===e.records.length&&$("#noData").fadeIn("slow").animate({opacity:1},2500).fadeOut("slow");var o=$.map(e.records,function(e){var a=e.primaryimageurl+"?width=600";return new ArtObject(e.title,e.department,e.primaryimageurl,a,e.dated,e.period,e.culture,e.dimensions,e.creditline)});appViewModel.artObjects(o),addLightbox()}).fail(function(e,a,t){console.log("HTTP Request Failed"),$("#noHarvard").fadeIn("slow").animate({opacity:1},2500).fadeOut("slow")})}function getGettyData(){var e=document.getElementById("js-city").value;$.ajax({url:"./json/"+e+".json",type:"GET",dataType:"json"}).done(function(e,a,t){var o=e.Response.doc.record,r=$.map(o,function(e){var a=e.imageThumbURI.replace("thumbnail","enlarge");return new ArtObject(e.PrimaryTitle,e.Department,a,e.imageThumbURI,e.Date,e.Place,e.Place,e.Dimensions,e.Source)});appViewModel.artObjects(r),addLightbox()}).fail(function(e,a,t){console.log("HTTP Request Failed"),$("#noGetty").fadeIn("slow").animate({opacity:1},2500).fadeOut("slow")})}function addLightbox(){var e=function(){$('<div id="imagelightbox-loading"><div></div></div>').appendTo("body")},a=function(){$("#imagelightbox-loading").remove()};$("a").imageLightbox({onLoadStart:function(){e()},onLoadEnd:function(){a()},onEnd:function(){a()}})}var map,activeMarker=null,infowindowOpen=!1,styles=[{elementType:"geometry",stylers:[{color:"#ebe3cd"}]},{elementType:"labels.text.fill",stylers:[{color:"#523735"}]},{elementType:"labels.text.stroke",stylers:[{color:"#f5f1e6"}]},{featureType:"administrative",elementType:"geometry.stroke",stylers:[{color:"#c9b2a6"}]},{featureType:"administrative.land_parcel",elementType:"geometry.stroke",stylers:[{color:"#dcd2be"}]},{featureType:"administrative.land_parcel",elementType:"labels.text.fill",stylers:[{color:"#ae9e90"}]},{featureType:"landscape.natural",elementType:"geometry",stylers:[{color:"#dfd2ae"}]},{featureType:"poi",elementType:"geometry",stylers:[{color:"#dfd2ae"}]},{featureType:"poi",elementType:"labels.text.fill",stylers:[{color:"#93817c"}]},{featureType:"poi.park",elementType:"geometry.fill",stylers:[{color:"#a5b076"}]},{featureType:"poi.park",elementType:"labels.text.fill",stylers:[{color:"#447530"}]},{featureType:"road",elementType:"geometry",stylers:[{color:"#f5f1e6"}]},{featureType:"road.arterial",elementType:"geometry",stylers:[{color:"#fdfcf8"}]},{featureType:"road.arterial",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"road.highway",elementType:"geometry",stylers:[{color:"#f8c967"}]},{featureType:"road.highway",elementType:"geometry.stroke",stylers:[{color:"#e9bc62"}]},{featureType:"road.highway",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"road.highway.controlled_access",elementType:"geometry",stylers:[{color:"#e98d58"}]},{featureType:"road.highway.controlled_access",elementType:"geometry.stroke",stylers:[{color:"#db8555"}]},{featureType:"road.local",stylers:[{visibility:"off"}]},{featureType:"road.local",elementType:"labels.text.fill",stylers:[{color:"#806b63"}]},{featureType:"transit.line",elementType:"geometry",stylers:[{color:"#dfd2ae"}]},{featureType:"transit.line",elementType:"labels.text.fill",stylers:[{color:"#8f7d77"}]},{featureType:"transit.line",elementType:"labels.text.stroke",stylers:[{color:"#ebe3cd"}]},{featureType:"transit.station",elementType:"geometry",stylers:[{color:"#dfd2ae"}]},{featureType:"water",elementType:"geometry.fill",stylers:[{color:"#b9d3c2"}]},{featureType:"water",elementType:"labels.text.fill",stylers:[{color:"#92998d"}]}],markers=[],tags=[],locations=[];document.getElementById("data").addEventListener("click",getHarvardData),document.getElementById("data-getty").addEventListener("click",getGettyData);var AppViewModel=function(){var e=this;e.artObjects=ko.observableArray([])},appViewModel=new AppViewModel;ko.applyBindings(appViewModel);var ArtObject=function(e,a,t,o,r,n,i,l,s){var c=this;c.title=e,c.department=a,c.imageLarge=t,c.imageThumb=o,c.date=r,c.period=n,c.culture=i,c.dimensions=l,c.creditline=s};